## lab3实验报告  

----

### 知识点  

#### 本次实验涉及到以下知识点：  

* 缺页中断的产生机制和处理例程  

* 基于FIFO的页面替换算法  
* 拓展时钟页面替换算法

* 虚拟内存管理机制  

#### 以下知识点也很重要，但是本次实验中没有体现:  
* 覆盖技术  

* 抖动和负载控制  

* 全局页替换算法  

---

### 练习一  

主要完善了当mm_struct中存在某虚拟地址，但是其对应的物理页不存在的情况。采取的策略是通过物理内存管理为该虚拟地址对应的页表项分配一个物理页。

这一过程中，主要用到页表项，页表项中与页替换算法相关的部分主要有：

```c
       31                                  12 11  9 8 7 6 5  4   3  2 1 0
      +--------------------------------------+-------+---+-+---+---+-+-+-+
      |                                      |     | | | | |   |   |U|R| |
      |      address of page       31..12    |igno |G|0|D|A|PCD|PWT|/|/|P|
      |                                      |     | | | | |   |   |S|W| |
      +--------------------------------------+-------+---+-+---+---+-+-+-+
      
```

* A : 上次清零之后是否被访问过。
* D: 脏位，上次清零之后是否被写过。
* P：present位，在页替换算法中可以用来作为该页面是否在物理内存中的标志。

如果缺页服务例程在处理异常的时候又发生了页访问异常，则此时CPU将会：

* 将异常的线性地址保存在CR2寄存器中
* 查询IDT找到页访问异常的中断服务程序入口点
* 向栈中压入cs、eip以及Error Code。Error Code记录了引发异常的原因。
* 跳到中断处理程序的入口。

在做上述几个步骤的同时， 还会进行相应的权限检查。如果没有通过对应的权限检查，则会触发保护错。（保护错也是lab1的challenge中比较容易出现的bug）。



### 练习二  

---

在ucore中，实现先入先出的页替换算法。可以维护一个物理页面链。每当新分配了一个物理页面，就将其加入到链尾，当需要还出一个物理页面到外存中时，选择链头的第一个物理页面进行交换。这样就实现了基于FIFO的页面替换算法。

当发生缺页中断时，在处理缺页中断的过程中，如果对应页表项不为0且该页表项的present位不为1,则认为该页表项对应的物理页被换出。这时应该将触发缺页异常的正在被访问的页面换入并修改页表映射。并将换入的物理页设置为可交换。

拓展时钟算法设计如下：

### 拓展时钟算法设计方案：  

----

我的设计思路：可以在原有的FIFO的框架基础上进行修改，从而实现拓展时钟算法。在拓展时钟算法中，维护一个时钟指针以及一个物理页面链表，时钟指针指向物理页面链表中的某个页面。

* 当需要进行页面的换入换出时，通过维护的时钟指针来进行寻找可以被换出的页面，具体寻找过程依据下面的判定过程：
  * 如果当前页的A位为0,D位为1,则将D位置为0,以此将该页面的修改内容写出。
  * 如果当前页的A位为0,D位也为0,则将该页换出。
  * 如果当前页的A位为1,则将A位置为0。

* 在进行页面的换入或者分配时，将换入或分配的物理页面加入到维护的时钟指针之后。

初始化时，算法处于启动阶段，将新分配的物理页面不断加入到物理页面链表中。当第一次进行页面换入换出时，算法正式进入运行阶段，之后链表的大小并没有变化，每一次换入会增加一个元素，而每一次换出会使链表减少一个元素。

